function clientErrorHandler(t,e,a,n){e.xhr?a.status(500).send({error:"Something failed!"}):n(t.message)}function required(t,e){if(!t)throw Error(e);return t}function repository(t){return t.data={},t.createEntity=(e=>{var a=t.create(e);return a.id=guid(),t.data[a.id]=a,a}),t.getData=(()=>Object.keys(t.data).map((e=>t.data[e]))),t}function createConsultation(t,e,a,n,i,o){var r=e[t];if(!r)throw Error("No patient with id: "+t);a.forEach((t=>t.consultationDate=moment(t.consultationDate)));var c=findPossibleDoctors(r.condition,n,a);if(0===c.length)throw Error("No doctors can treat a patient with "+r.condition);var s=findPossibleRooms(r.condition,i,a,o);if(0===s.length)throw Error("No rooms can treat a patient with "+r.condition);var d=moment(),u=findNextDate(d,c,s);return u.patientId=t,u.registrationDate=d.format("YYYY-MM-DD"),u}function findPossibleDoctors(t,e,a){var n="headandneckcancer"===t||"breastcancer"===t?"Oncologist":"GeneralPractitioner";return e.filter((t=>t.roles.some((t=>t===n)))).map((t=>{return t.consultations=a.filter((e=>e.doctorId===t.id)),t}))}function findPossibleRooms(t,e,a,n){return e.filter((e=>{return"headandneckcancer"===t?e.treatmentMachineId&&"advanced"===getMachine(e.treatmentMachineId,n).capability:"breastcancer"!==t||e.treatmentMachineId})).map((t=>{return t.consultations=a.filter((e=>e.roomId===t.id)),t}))}function getMachine(t,e){return e.filter((e=>e.id===t))[0]}function earliestConsultationDate(t,e){return t.consultationDate-e.consultationDate}function findNextDate(t,e,a){for(var n=t.clone().add(1,"days");;){var i=findAvailableForDate(e,n),o=findAvailableForDate(a,n);if(i&&o)return{doctorId:i.id,roomId:o.id,consultationDate:n.startOf("day").format("YYYY-MM-DD")};n=n.add(1,"days")}}function findAvailableForDate(t,e){for(var a=0;a<t.length;a++){var n=t[a],i=recShiftUntilLater(n.consultations.shift(),n.consultations,e);if(i)return n}}function recShiftUntilLater(t,e,a){return!t||!t.consultationDate.isSame(a,"day")&&recFindNext(e.shift(),e,a)}var express=require("express"),bodyParser=require("body-parser"),guid=require("node-uuid").v1,moment=require("moment"),cors=require("cors"),conditions={headandneckcancer:"headandneckcancer",breastcancer:"breastcancer",flu:"flu"},api={patients:repository({create:t=>({name:t.name,condition:required(conditions[t.condition],'Required parameter "condition" must be of value "headandneckcancer", "breastcancer" or "flu"'),imageId:t.imageId})}),images:repository({post:!0,create:t=>({url:t.url})}),consultations:repository({create:t=>({registrationDate:t.registrationDate,patientId:t.patientId,doctorId:t.doctorId,roomId:t.roomId,consultationDate:t.consultationDate})}),doctors:repository({create:t=>({name:t.name,roles:t.roles,imageId:t.imageId})}),rooms:repository({create:t=>({name:t.name,treatmentMachineId:t.treatmentMachineId})}),machines:repository({create:t=>({name:t.name,capability:t.capability})})},image_john=api.images.createEntity({url:"http://image.shutterstock.com/z/stock-photo-doctor-and-globe-isolated-on-white-37473454.jpg"}),image_anna=api.images.createEntity({url:"http://thumb1.shutterstock.com/display_pic_with_logo/81251/81251,1252775897,4/stock-photo-friendly-female-doctor-smiling-to-you-next-to-a-clinic-36933940.jpg"}),image_peter=api.images.createEntity({url:"http://thumb7.shutterstock.com/display_pic_with_logo/974128/193955219/stock-photo-cheerful-middle-aged-doctor-isolated-on-white-193955219.jpg"});api.doctors.createEntity({name:"John",roles:["Oncologist"],imageId:image_john.id}),api.doctors.createEntity({name:"Anna",roles:["GeneralPractitioner"],imageId:image_anna.id}),api.doctors.createEntity({name:"Peter",roles:["Oncologist","GeneralPractitioner"],imageId:image_peter.id});var elekta=api.machines.createEntity({name:"Elekta",capability:"advanced"}),varian=api.machines.createEntity({name:"Varian",capability:"advanced"}),mm50=api.machines.createEntity({name:"MM50",capability:"simple"});api.rooms.createEntity({name:"One",treatmentMachineId:elekta.id}),api.rooms.createEntity({name:"Two",treatmentMachineId:varian.id}),api.rooms.createEntity({name:"Three",treatmentMachineId:mm50.id}),api.rooms.createEntity({name:"Four"}),api.rooms.createEntity({name:"Five"});var app=express();app.use(cors()),app.use(bodyParser.urlencoded({extended:!1})),app.use(bodyParser.json()),app.use(clientErrorHandler),app.get("/",((t,e)=>e.send(`Scheduling system API`))),Object.keys(api).forEach((t=>{var e=api[t];app.get(`/${t}`,((t,a)=>a.send(e.getData()))),app.get(`/${t}/:id`,((t,a)=>e.data[t.params.id]?a.send(e.data[t.params.id]):a.status(404).send())),e.post&&app.post(`/${t}`,((t,a)=>a.send(e.createEntity(t.body))))})),app.post("/patients",((t,e)=>{var a=api.patients.createEntity(t.body);api.consultations.createEntity(createConsultation(a.id,api.patients.data,api.consultations.getData(),api.doctors.getData(),api.rooms.getData(),api.machines.getData())),e.send(a)})),app.listen(8080,(()=>console.log(`Server listening on port ${8080}!`)));